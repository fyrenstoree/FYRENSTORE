<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Keuangan Profesional (Tema Putih)</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #f8f9fa;
      --card: #ffffff;
      --accent: #4cc9f0;
      --accent-dark: #0096c7;
      --text: #1a1a1a;
      --muted: #6c757d;
      --danger: #dc3545;
      --border: #dee2e6;
      --radius: 12px;
    }
    * {
      box-sizing: border-box;
      font-family: "Poppins", sans-serif;
    }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      padding: 20px;
    }
    .app {
      max-width: 1200px;
      margin: auto;
      display: flex;
      gap: 20px;
    }
    .left {
      flex: 1;
      background: var(--card);
      border-radius: var(--radius);
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    .right {
      width: 350px;
      background: var(--card);
      border-radius: var(--radius);
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      height: fit-content;
    }
    .status-card {
      padding: 15px;
      border-radius: var(--radius);
      margin-bottom: 15px;
      color: white;
      font-weight: 600;
    }
    .status-card.pending {
      background: linear-gradient(135deg, #ffc107, #ffb300);
    }
    .status-card.tunai {
      background: linear-gradient(135deg, #28a745, #20c997);
    }
    .status-card.selesai {
      background: linear-gradient(135deg, #17a2b8, #0c5460);
    }
    .status-card.return {
      background: linear-gradient(135deg, #dc3545, #c82333);
    }
    .status-label {
      font-size: 12px;
      opacity: 0.9;
      margin-bottom: 5px;
    }
    .status-amount {
      font-size: 18px;
      font-weight: 700;
      word-break: break-word;
    }
    h1 {margin: 0; font-size: 22px; color: var(--accent-dark);}
    h3 {margin: 0 0 10px 0;}
    .controls {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin: 10px 0;
    }
    .btn {
      background: var(--accent);
      border: none;
      color: #fff;
      font-weight: 700;
      border-radius: var(--radius);
      padding: 10px 14px;
      cursor: pointer;
    }
    .btn:hover { background: var(--accent-dark); }
    .btn-ghost {
      border: 1px solid var(--border);
      background: transparent;
      color: var(--text);
      font-weight: 600;
      border-radius: var(--radius);
      padding: 10px 14px;
      cursor: pointer;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid var(--border);
      padding: 8px;
      text-align: center;
    }
    thead th {
      background: #e9ecef;
    }
    tfoot td {
      font-weight: 700;
      background: #f1f3f5;
    }
    .number { text-align: right; padding-right: 12px; }
    .action-btn {
      border: none;
      border-radius: var(--radius);
      padding: 6px 10px;
      cursor: pointer;
      font-weight: 600;
      margin: 0 4px;
    }
    .edit-btn { background: #ffc107; color: #000; }
    .del-btn { background: var(--danger); color: #fff; }
    .month-nav {
      margin-top: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .nav-btn {
      border: 1px solid var(--border);
      background: var(--card);
      border-radius: 8px;
      cursor: pointer;
      padding: 6px 12px;
    }
    .totals-panel .line {
      display: flex;
      justify-content: space-between;
      border-bottom: 1px solid var(--border);
      padding: 6px 0;
    }
    .lbl { color: var(--muted); font-size: 14px; }
    .val { font-weight: 700; }
    .muted-note { color: var(--muted); font-size: 13px; margin-top: 10px; }
    #modeToggle { margin-left: auto; }
    .search-box {
      margin: 15px 0;
      display: flex;
      gap: 8px;
    }
    #searchPelanggan {
      flex: 1;
      padding: 10px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-size: 14px;
    }
    #btnClearSearch {
      padding: 10px 14px;
      border: 1px solid var(--border);
      background: transparent;
      border-radius: var(--radius);
      cursor: pointer;
      font-weight: 600;
    }
    #btnClearSearch:hover { background: #f8f9fa; }

    /* Modal */
    #overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      align-items: center;
      justify-content: center;
    }
    .chart-container {
      background: var(--card);
      border-radius: var(--radius);
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      margin-top: 20px;
      position: relative;
      height: 400px;
    }
    .chart-container h3 {
      margin: 0 0 15px 0;
      color: var(--accent-dark);
    }
    .modal {
      background: var(--card);
      padding: 20px;
      border-radius: var(--radius);
      width: 90%;
      max-width: 400px;
      box-shadow: 0 3px 15px rgba(0,0,0,0.1);
    }
    .modal label { font-weight: 600; font-size: 14px; }
    .modal input {
      width: 100%;
      padding: 8px;
      border-radius: 8px;
      border: 1px solid var(--border);
      margin-bottom: 10px;
    }
    .modal-btns { text-align: right; margin-top: 10px; }

    /* Responsive / HP Mode */
    @media (max-width: 768px) {
      .app { flex-direction: column; }
      .right { width: 100%; }
      .controls { justify-content: space-between; }
      .btn, .btn-ghost { flex: 1; text-align: center; }
      table { font-size: 14px; overflow-x: auto; display: block; }
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="left">
      <h1>Keuangan FYREN STORE</h1>
      <div class="search-box">
        <input id="searchPelanggan" type="text" placeholder="ðŸ” Cari nama pelanggan...">
        <button id="btnClearSearch" class="btn-ghost">Reset</button>
      </div>
      <div class="controls">
        <button id="btnAddRow" class="btn">Tambah Baris</button>
        <button id="btnExport" class="btn-ghost">Export XLSX</button>
        <button id="modeToggle" class="btn-ghost">Mode HP</button>
      </div>

      <table id="dataTable">
        <thead>
          <tr>
            <th>No</th><th>Tanggal</th><th>Nama Pelanggan</th><th>Product</th><th>Qty</th>
            <th>Harga Beli</th><th>Harga Jual</th><th>Laba</th><th>PRA HUTANG</th><th>Status</th><th>Aksi</th>
          </tr>
        </thead>
        <tbody></tbody>
        <tfoot>
          <tr>
            <td colspan="4">TOTAL</td>
            <td id="sumHargaBeli" class="number">Rp 0</td>
            <td id="sumHargaJual" class="number">Rp 0</td>
            <td id="sumLaba" class="number">Rp 0</td>
            <td id="sumJumlah" class="number">Rp 0</td>
            <td></td>
          </tr>
        </tfoot>
      </table>

      <div class="month-nav">
        <button id="prevMonth" class="nav-btn">&lt;</button>
        <div id="monthDisplay" style="font-weight:700;"></div>
        <button id="nextMonth" class="nav-btn">&gt;</button>
      </div>

      <div class="chart-container">
        <h3>ï¿½ Produk Per Tanggal</h3>
        <canvas id="dailyChart"></canvas>
      </div>
    </div>

    <div class="right">
      <h3>ðŸ“Š Total Bulanan</h3>
      <div class="totals-panel">
        <div class="line"><div class="lbl">Total Harga Beli</div><div id="rbBeli" class="val">Rp 0</div></div>
        <div class="line"><div class="lbl">Total Harga Jual</div><div id="rbJual" class="val">Rp 0</div></div>
        <div class="line"><div class="lbl">Total Laba</div><div id="rbLaba" class="val">Rp 0</div></div>
        <div class="line"><div class="lbl">Total PRA HUTANG</div><div id="rbJumlah" class="val">Rp 0</div></div>
      </div>
      
      <h3 style="margin-top: 20px;">ðŸ’° Keuangan per Status</h3>
      <div class="status-card pending">
        <div class="status-label">PENDING (Menunggu Pembayaran)</div>
        <div class="status-amount" id="rbPending">Rp 0</div>
      </div>
      <div class="status-card tunai">
        <div class="status-label">TUNAI (Lunas Tunai)</div>
        <div class="status-amount" id="rbTunai">Rp 0</div>
      </div>
      <div class="status-card selesai">
        <div class="status-label">SELESAI (Transaksi Selesai)</div>
        <div class="status-amount" id="rbSelesai">Rp 0</div>
      </div>
      <div class="status-card return">
        <div class="status-label">RETURN (Produk Dikembalikan)</div>
        <div class="status-amount" id="rbReturn">Rp 0</div>
      </div>
      
      <div class="muted-note" style="margin-top: 20px;">âœ“ Semua total otomatis terhitung dari baris transaksi.</div>
    </div>
  </div>

  <!-- Modal -->
  <div id="overlay">
    <div class="modal">
      <h3>Edit Baris</h3>
      <label>Tanggal</label><input id="m_date" type="date">
      <label>Nama Pelanggan</label><input id="m_pelanggan" type="text">
      <label>Nama Product</label><input id="m_product" type="text">
      <label>Qty</label><input id="m_qty" type="number">
      <label>Harga Beli</label><input id="m_hb" type="number">
      <label>Harga Jual</label><input id="m_hj" type="number">
      <label>Laba</label><input id="m_laba" type="number" readonly>
      <label>PRA HUTANG</label><input id="m_jumlah" type="number">
      <div class="modal-btns">
        <button id="saveModal" class="btn">Simpan</button>
        <button id="cancelModal" class="btn-ghost">Batal</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const monthNames = ["JAN","FEB","MAR","APR","MEI","JUN","JUL","AGU","SEP","OKT","NOV","DES"];
    const PREFIX = 'fyren_white_';
    let rows = [];
    let curY, curM;
    let filteredRows = [];
    let searchQuery = '';
    const statusTotals = { pending:0, tunai:0, selesai:0, return:0 };

    const tbody = document.querySelector('#dataTable tbody');
    const rbBeli = document.getElementById('rbBeli');
    const rbJual = document.getElementById('rbJual');
    const rbLaba = document.getElementById('rbLaba');
    const rbJumlah = document.getElementById('rbJumlah');
    const monthDisplay = document.getElementById('monthDisplay');
    
    let dailyChartInstance = null;

    const fmt = n => 'Rp ' + (Number(n)||0).toLocaleString('id-ID');
    
    // Format tanggal dari YYYY-MM-DD menjadi DD-MM-YYYY
    const fmtDate = (dateStr) => {
      if(!dateStr) return '';
      const [year, month, day] = dateStr.split('-');
      return `${day}-${month}-${year}`;
    };

    function monthKey(y,m){return PREFIX+y+'_'+String(m+1).padStart(2,'0');}
    function saveMonth(){localStorage.setItem(monthKey(curY,curM),JSON.stringify(rows));}
    function loadMonth(y,m){
      const d = localStorage.getItem(monthKey(y,m));
      return d?JSON.parse(d):[];
    }

    function recalc(){
      let sb=0,sj=0,sl=0,sju=0;
      rows.forEach(r=>{
        sb+=+r.hargaBeli||0;
        sj+=+r.hargaJual||0;
        sl+=+r.laba||0;
        sju+=+r.jumlah||0;
      });
      document.getElementById('sumHargaBeli').textContent=fmt(sb);
      document.getElementById('sumHargaJual').textContent=fmt(sj);
      document.getElementById('sumLaba').textContent=fmt(sl);
      document.getElementById('sumJumlah').textContent=fmt(sju);
      rbBeli.textContent=fmt(sb);
      rbJual.textContent=fmt(sj);
      rbLaba.textContent=fmt(sl);
      rbJumlah.textContent=fmt(sju);
      recalcStatusTotals();
    }

    function recalcStatusTotals(){
      statusTotals.pending = 0;
      statusTotals.tunai = 0;
      statusTotals.selesai = 0;
      statusTotals.return = 0;
      // Hitung dari SEMUA rows, bukan dari filtered
      rows.forEach(r=>{
        const amt = +r.hargaJual || 0;
        if(r.status === 'pending') statusTotals.pending += amt;
        if(r.status === 'tunai') statusTotals.tunai += amt;
        if(r.status === 'selesai') statusTotals.selesai += amt;
        if(r.status === 'return') statusTotals.return += amt;
      });
      // update UI (per-bulan, berdasarkan harga jual tiap baris)
      const rbPending = document.getElementById('rbPending');
      const rbTunai = document.getElementById('rbTunai');
      const rbSelesai = document.getElementById('rbSelesai');
      const rbReturn = document.getElementById('rbReturn');
      if(rbPending) rbPending.textContent = fmt(statusTotals.pending);
      if(rbTunai) rbTunai.textContent = fmt(statusTotals.tunai);
      if(rbSelesai) rbSelesai.textContent = fmt(statusTotals.selesai);
      if(rbReturn) rbReturn.textContent = fmt(statusTotals.return);
    }

    function updateDailyChart(){
      // Ambil jumlah hari di bulan ini
      const daysInMonth = new Date(curY, curM + 1, 0).getDate();
      const dailyData = {};
      
      // Inisialisasi semua hari dengan 0
      for(let i = 1; i <= daysInMonth; i++){
        dailyData[i] = 0;
      }
      
      // Hitung jumlah transaksi per hari
      rows.forEach(r => {
        if(r.date){
          const parts = r.date.split('-');
          if(parts.length === 3){
            const day = parseInt(parts[2]);
            dailyData[day] = (dailyData[day] || 0) + 1;
          }
        }
      });
      
      // Siapkan data untuk chart
      const labels = Array.from({length: daysInMonth}, (_, i) => i + 1);
      const data = labels.map(day => dailyData[day]);
      
      // Destroy chart lama jika ada
      if(dailyChartInstance){
        dailyChartInstance.destroy();
      }
      
      // Buat chart baru dengan BAR CHART
      const ctx = document.getElementById('dailyChart');
      if(ctx){
        dailyChartInstance = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [{
              label: 'Jumlah Produk Ditambah',
              data: data,
              backgroundColor: [
                '#4cc9f0', '#0096c7', '#00b4d8', '#90e0ef', '#caf0f8',
                '#4cc9f0', '#0096c7', '#00b4d8', '#90e0ef', '#caf0f8',
                '#4cc9f0', '#0096c7', '#00b4d8', '#90e0ef', '#caf0f8',
                '#4cc9f0', '#0096c7', '#00b4d8', '#90e0ef', '#caf0f8',
                '#4cc9f0', '#0096c7', '#00b4d8', '#90e0ef', '#caf0f8',
                '#4cc9f0', '#0096c7', '#00b4d8', '#90e0ef', '#caf0f8',
                '#4cc9f0'
              ],
              borderColor: '#0096c7',
              borderWidth: 2,
              borderRadius: 8
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'x',
            plugins: {
              legend: {
                display: true,
                labels: {
                  font: {size: 12, weight: 600},
                  padding: 15
                }
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  stepSize: 1,
                  callback: function(value) {
                    return value + ' produk';
                  },
                  font: {size: 11}
                }
              },
              x: {
                ticks: {
                  font: {size: 11}
                }
              }
            }
          }
        });
      }
    }

    function render(){
      tbody.innerHTML='';
      // Apply search filter - jika search kosong, tampilkan semua
      if(searchQuery.trim() === ''){
        filteredRows = rows;
      } else {
        filteredRows = rows.filter(r => 
          r.pelanggan && r.pelanggan.toLowerCase().includes(searchQuery.toLowerCase())
        );
      }
      
      filteredRows.forEach((r,i)=>{
        const tr=document.createElement('tr');
        const pendingOutline = r.status==='pending' ? 'outline:3px solid #999;' : '';
        const tunaiOutline = r.status==='tunai' ? 'outline:3px solid #999;' : '';
        const selesaiOutline = r.status==='selesai' ? 'outline:3px solid #999;' : '';
        const returnOutline = r.status==='return' ? 'outline:3px solid #999;' : '';
        tr.innerHTML=`
          <td>${i+1}</td><td>${fmtDate(r.date)||''}</td><td>${r.pelanggan||''}</td><td>${r.product||''}</td><td>${r.qty||0}</td>
          <td class='number'>${fmt(r.hargaBeli)}</td>
          <td class='number'>${fmt(r.hargaJual)}</td>
          <td class='number'>${fmt(r.laba)}</td>
          <td class='number'>${fmt(r.jumlah)}</td>
          <td>
            <button class='action-btn status-pending' data-id='${r.id}' style='background:#ffd966;${pendingOutline}'>Pending</button>
            <button class='action-btn status-tunai' data-id='${r.id}' style='background:#b6d7a8;${tunaiOutline}'>Tunai</button>
            <button class='action-btn status-selesai' data-id='${r.id}' style='background:#9fc5e8;${selesaiOutline}'>Selesai</button>
            <button class='action-btn status-return' data-id='${r.id}' style='background:#dc3545;${returnOutline}'>Return</button>
          </td>
          <td><button class='action-btn edit-btn' data-id='${r.id}'>Edit</button>
              <button class='action-btn del-btn' data-id='${r.id}'>Hapus</button></td>`;
        tbody.appendChild(tr);
      });
      recalc();
      attachRowListeners();
      monthDisplay.textContent=monthNames[curM]+' '+curY;
      updateDailyChart();
    }

    function attachRowListeners(){
      document.querySelectorAll('.del-btn').forEach(btn=>btn.onclick=()=>{
        const id=btn.dataset.id;
        rows=rows.filter(r=>r.id!==id);
        saveMonth();render();
      });
      document.querySelectorAll('.edit-btn').forEach(btn=>btn.onclick=()=>openEdit(btn.dataset.id));
      document.querySelectorAll('.status-pending').forEach(btn=>btn.onclick=()=>setStatus(btn.dataset.id,'pending'));
      document.querySelectorAll('.status-tunai').forEach(btn=>btn.onclick=()=>setStatus(btn.dataset.id,'tunai'));
      document.querySelectorAll('.status-selesai').forEach(btn=>btn.onclick=()=>setStatus(btn.dataset.id,'selesai'));
      document.querySelectorAll('.status-return').forEach(btn=>btn.onclick=()=>setStatus(btn.dataset.id,'return'));
    }

    function setStatus(id, newStatus){
      const r = rows.find(x=>x.id===id);
      if(!r) return;
      r.status = newStatus;
      saveMonth();
      render();
    }

    // Add row
    document.getElementById('btnAddRow').onclick=()=>{
      const id=Date.now().toString(36);
      rows.push({id,date:'',pelanggan:'',product:'',qty:0,hargaBeli:0,hargaJual:0,laba:0,jumlah:0,status:'none'});
      saveMonth();render();openEdit(id);
    };

    // Modal
    const overlay=document.getElementById('overlay');
    let editingId=null;
    const inputs={date:m_date,pelanggan:m_pelanggan,product:m_product,qty:m_qty,hb:m_hb,hj:m_hj,laba:m_laba,jumlah:m_jumlah};
    function openEdit(id){
      const r=rows.find(x=>x.id===id);
      if(!r)return;
      editingId=id;
      m_date.value=r.date||'';
      m_pelanggan.value=r.pelanggan||'';
      m_product.value=r.product||'';
      m_qty.value=r.qty||0;
      m_hb.value=r.hargaBeli||0;
      m_hj.value=r.hargaJual||0;
      m_laba.value=r.laba||0;
      m_jumlah.value=r.jumlah||0;
      // Auto-calculate laba saat modal dibuka
      updateLabaOtomatis();
      overlay.style.display='flex';
    }
    
    // Function untuk auto-calculate Laba
    function updateLabaOtomatis(){
      const hb = +m_hb.value || 0;
      const hj = +m_hj.value || 0;
      const laba = hj - hb;
      m_laba.value = laba;
    }
    
    // Event listener untuk auto-calculate saat input Harga Beli atau Harga Jual
    m_hb.addEventListener('input', updateLabaOtomatis);
    m_hj.addEventListener('input', updateLabaOtomatis);
    saveModal.onclick=()=>{
      const r=rows.find(x=>x.id===editingId);
      if(!r)return;
      r.date=m_date.value;
      r.pelanggan=m_pelanggan.value;
      r.product=m_product.value;
      r.qty=+m_qty.value||0;
      r.hargaBeli=+m_hb.value||0;
      r.hargaJual=+m_hj.value||0;
      r.laba=+m_laba.value||0;
      r.jumlah=+m_jumlah.value||0;
      overlay.style.display='none';
      saveMonth();render();
    };
    cancelModal.onclick=()=>overlay.style.display='none';
    overlay.onclick=e=>{if(e.target===overlay)overlay.style.display='none';};

    // Month nav
    document.getElementById('prevMonth').onclick=()=>{
      saveMonth();
      let y=curY,m=curM-1;if(m<0){m=11;y--;}loadSet(y,m);
    };
    document.getElementById('nextMonth').onclick=()=>{
      saveMonth();
      let y=curY,m=curM+1;if(m>11){m=0;y++;}loadSet(y,m);
    };
    function loadSet(y,m){curY=y;curM=m;rows=loadMonth(y,m);render();}

    // Mode toggle
    document.getElementById('modeToggle').onclick=()=>{
      document.body.classList.toggle('mobile');
    };

    // Search functionality
    document.getElementById('searchPelanggan').addEventListener('input', (e) => {
      searchQuery = e.target.value;
      render();
    });

    document.getElementById('btnClearSearch').onclick = () => {
      document.getElementById('searchPelanggan').value = '';
      searchQuery = '';
      render();
    };

    // Init
    (()=>{
      const n=new Date();curY=n.getFullYear();curM=n.getMonth();
      rows=loadMonth(curY,curM);
      render();
    })();
  </script>
</body>
</html>
